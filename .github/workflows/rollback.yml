name: Emergency Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      target_commit:
        description: 'Commit SHA to rollback to (leave empty for previous deployment)'
        required: false
        type: string
      reason:
        description: 'Reason for rollback'
        required: true
        type: string
      confirm_rollback:
        description: 'Type "ROLLBACK" to confirm emergency rollback'
        required: true
        type: string

permissions:
  contents: read
  deployments: write
  id-token: write

env:
  NODE_VERSION: '18'

jobs:
  validate-admin:
    name: Validate Admin Access
    runs-on: ubuntu-latest
    steps:
      - name: Check admin permissions
        uses: actions/github-script@v6
        with:
          script: |
            const actor = context.actor;
            const repo = context.repo;
            
            // Check if user has admin or write permissions
            const { data: permissions } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: repo.owner,
              repo: repo.repo,
              username: actor
            });
            
            const hasAdminAccess = permissions.permission === 'admin' || permissions.permission === 'write';
            
            if (!hasAdminAccess) {
              core.setFailed(`‚ùå Access denied: ${actor} does not have admin/write permissions. Only repository admins can perform rollbacks.`);
            }
            
            // Validate rollback confirmation
            const confirmInput = '${{ github.event.inputs.confirm_rollback }}';
            if (confirmInput !== 'ROLLBACK') {
              core.setFailed('‚ùå Rollback confirmation required. Please type "ROLLBACK" in the confirm_rollback input.');
            }
            
            const environment = '${{ github.event.inputs.environment }}';
            const reason = '${{ github.event.inputs.reason }}';
            
            core.info(`‚úÖ Admin access validated for ${actor}`);
            core.info(`üîÑ Rollback requested for ${environment}`);
            core.info(`üìù Reason: ${reason}`);

  rollback:
    name: Rollback ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    needs: [validate-admin]
    if: needs.validate-admin.result == 'success'
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_commit || github.sha }}

      - name: Determine rollback target
        id: rollback-target
        run: |
          if [ -n "${{ github.event.inputs.target_commit }}" ]; then
            echo "target=${{ github.event.inputs.target_commit }}" >> $GITHUB_OUTPUT
            echo "Rolling back to specific commit: ${{ github.event.inputs.target_commit }}"
          else
            # Get the previous successful deployment commit
            PREV_COMMIT=$(gh api repos/${{ github.repository }}/deployments \
              --jq '.[0].sha' \
              --header "Authorization: token ${{ secrets.GITHUB_TOKEN }}")
            echo "target=$PREV_COMMIT" >> $GITHUB_OUTPUT
            echo "Rolling back to previous deployment: $PREV_COMMIT"
          fi

      - name: Create rollback backup
        run: |
          echo "Creating rollback backup..."
          # Trigger backup before rollback

      - name: Rollback Backend
        if: github.event.inputs.environment == 'production'
        env:
          RENDER_SERVICE_ID: ${{ secrets.RENDER_PRODUCTION_SERVICE_ID }}
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          TARGET_COMMIT: ${{ steps.rollback-target.outputs.target }}
        run: |
          curl -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"commit\": \"${TARGET_COMMIT}\"}"

      - name: Rollback Backend (Staging)
        if: github.event.inputs.environment == 'staging'
        env:
          RENDER_SERVICE_ID: ${{ secrets.RENDER_STAGING_SERVICE_ID }}
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          TARGET_COMMIT: ${{ steps.rollback-target.outputs.target }}
        run: |
          curl -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"commit\": \"${TARGET_COMMIT}\"}"

      - name: Rollback Frontend
        if: github.event.inputs.environment == 'production'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_PRODUCTION_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PRODUCTION_PROJECT_ID }}
          vercel-args: '--prod'
          git-commit-sha: ${{ steps.rollback-target.outputs.target }}

      - name: Rollback Frontend (Staging)
        if: github.event.inputs.environment == 'staging'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_STAGING_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_STAGING_PROJECT_ID }}
          vercel-args: '--prod'
          git-commit-sha: ${{ steps.rollback-target.outputs.target }}

      - name: Health Check
        run: |
          sleep 60
          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            curl -f ${{ secrets.PRODUCTION_BACKEND_URL }}/health || exit 1
            curl -f ${{ secrets.PRODUCTION_FRONTEND_URL }} || exit 1
          else
            curl -f ${{ secrets.STAGING_BACKEND_URL }}/health || exit 1
            curl -f ${{ secrets.STAGING_FRONTEND_URL }} || exit 1
          fi

      - name: Run smoke tests
        run: |
          npm ci
          if [ "${{ github.event.inputs.environment }}" == "production" ]; then
            curl -f ${{ secrets.PRODUCTION_FRONTEND_URL }} || exit 1
          else
            curl -f ${{ secrets.STAGING_FRONTEND_URL }} || exit 1
          fi

      - name: Notify successful rollback
        uses: 8398a7/action-slack@v3
        if: success()
        with:
          status: success
          fields: workflow,status
          custom_payload: |
            {
              "attachments": [{
                "color": "warning",
                "title": "üîÑ Rollback Completed Successfully",
                "text": "Environment: ${{ github.event.inputs.environment }}\nReason: ${{ github.event.inputs.reason }}\nTarget: ${{ steps.rollback-target.outputs.target }}\nTriggered by: ${{ github.actor }}"
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify failed rollback
        uses: 8398a7/action-slack@v3
        if: failure()
        with:
          status: custom
          fields: workflow,status
          custom_payload: |
            {
              "attachments": [{
                "color": "danger",
                "title": "‚ùå Rollback Failed",
                "text": "Environment: ${{ github.event.inputs.environment }}\nReason: ${{ github.event.inputs.reason }}\nTarget: ${{ steps.rollback-target.outputs.target }}\nTriggered by: ${{ github.actor }}\n\nManual intervention required!"
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Create rollback issue
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Rollback Failed: ${{ github.event.inputs.environment }}`,
              body: `
            ## Rollback Failure Details

            **Environment:** ${{ github.event.inputs.environment }}
            **Reason:** ${{ github.event.inputs.reason }}
            **Target Commit:** ${{ steps.rollback-target.outputs.target }}
            **Triggered by:** ${{ github.actor }}
            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ### Immediate Actions Required:
            - [ ] Investigate the rollback failure
            - [ ] Manually restore from backup if necessary
            - [ ] Update monitoring dashboards
            - [ ] Notify stakeholders
            - [ ] Document the incident

            ### Logs:
            Check the workflow logs for detailed error information.
              `,
              labels: ['rollback-failure', 'urgent', 'incident']
            })
