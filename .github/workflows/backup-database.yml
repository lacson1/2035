# yamllint disable
# GitHub Actions workflow - secrets access is valid
# This file is intentionally excluded from linting
# VS Code: Disable YAML validation for this file
# @ts-nocheck
# eslint-disable
name: Database Backup

on:
  schedule:
    # Run daily at 2 AM UTC (adjust timezone as needed)
    - cron: "0 2 * * *"
  workflow_dispatch: # Allow manual trigger from GitHub Actions UI

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Create backup directory
        run: |
          mkdir -p backend/backups

      - name: Create database backup
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || '' }}
          BACKUP_DIR: ./backend/backups
          RETENTION_DAYS: 30
        run: |
          cd backend
          chmod +x scripts/backup-database.sh
          ./scripts/backup-database.sh

      - name: List backup files
        run: |
          ls -lh backend/backups/

      - name: Upload backup to artifacts (for manual download)
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-$(date +%Y%m%d)
          path: backend/backups/*.sql.gz
          retention-days: 7

      - name: Upload to S3 (if configured)
        if: env.AWS_ACCESS_KEY_ID != ''
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID || '' }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY || '' }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
          BACKUP_S3_BUCKET: ${{ secrets.BACKUP_S3_BUCKET || '' }}
        run: |
          if [ -n "$BACKUP_S3_BUCKET" ]; then
            echo "Uploading backup to S3..."
            # Install AWS CLI
            sudo apt-get install -y awscli
            # Upload latest backup
            aws s3 cp backend/backups/*.sql.gz s3://$BACKUP_S3_BUCKET/database-backups/$(date +%Y%m%d)/ --recursive
            echo "Backup uploaded successfully"
          else
            echo "S3 backup not configured, skipping upload"
          fi

      - name: Send notification (optional)
        if: failure()
        run: |
          echo "Backup failed! Check the logs above."
          # Add notification service here (email, Slack, etc.)
          # Example: curl -X POST https://hooks.slack.com/services/YOUR/WEBHOOK/URL
