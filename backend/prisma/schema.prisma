generator client {
  provider = "prisma-client-js"
  binaryTargets = ["debian-openssl-3.0.x", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  physician
  nurse
  nurse_practitioner
  physician_assistant
  medical_assistant
  receptionist
  billing
  pharmacist
  lab_technician
  radiologist
  therapist
  social_worker
  care_coordinator
  read_only
}

// Dynamic Role and Permission System
model Permission {
  id          String   @id @default(uuid())
  code        String   @unique // e.g., "patients:read", "patients:write"
  name        String   // Display name: "Read Patients"
  description String?  @db.Text
  category    String?  // e.g., "patients", "medications", "billing"
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  rolePermissions RolePermission[]

  @@index([code])
  @@index([category])
  @@index([isActive])
  @@map("permissions")
}

model Role {
  id          String   @id @default(uuid())
  code        String   @unique // e.g., "admin", "physician" - matches UserRole enum for backward compatibility
  name        String   // Display name: "Administrator"
  description String?  @db.Text
  color       String?  // Color code for UI (e.g., "red", "#EF4444")
  isSystem    Boolean  @default(false) @map("is_system") // System roles cannot be deleted
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  rolePermissions RolePermission[]

  @@index([code])
  @@index([isActive])
  @@map("roles")
}

model RolePermission {
  id           String   @id @default(uuid())
  roleId       String   @map("role_id")
  permissionId String   @map("permission_id")
  createdAt    DateTime @default(now()) @map("created_at")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

enum MedicationStatus {
  Active
  Discontinued
  Historical
  Archived
}

enum AppointmentStatus {
  scheduled
  completed
  cancelled
}

enum ClinicalNoteType {
  visit
  consultation
  procedure
  follow_up
  general_consultation
  specialty_consultation
}

enum ImagingModality {
  CT
  MRI
  XRay
  Ultrasound
  PET
}

enum ImagingStatus {
  completed
  pending
  cancelled
}

enum LabStatus {
  ordered
  in_progress
  completed
  cancelled
  pending_review
}

enum DocumentType {
  medical_record
  lab_report
  imaging_report
  prescription
  insurance_form
  consent_form
  discharge_summary
  referral_letter
  other
}

enum TimelineEventType {
  appointment
  note
  medication
  imaging
  lab
}

enum ReferralStatus {
  pending
  sent
  accepted
  completed
  cancelled
  declined
}

enum ReferralPriority {
  routine
  urgent
  stat
  emergency
}

enum InvoiceStatus {
  draft
  pending
  sent
  paid
  overdue
  cancelled
  refunded
}

enum PaymentMethod {
  cash
  card
  bank_transfer
  mobile_money
  insurance
  check
  other
}

enum PaymentStatus {
  pending
  completed
  failed
  refunded
  cancelled
}

model User {
  id           String    @id @default(uuid())
  username     String    @unique
  email        String    @unique
  passwordHash String    @map("password_hash")
  firstName    String    @map("first_name")
  lastName     String    @map("last_name")
  role         UserRole
  specialty    String?
  department   String?
  phone        String?
  avatarUrl    String?   @map("avatar_url")
  isActive     Boolean   @default(true) @map("is_active")
  lastLogin    DateTime? @map("last_login")
  preferences  Json?     // User preferences (theme, notifications, dashboard settings, etc.)
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  createdPatients       Patient[]            @relation("PatientCreatedBy")
  updatedPatients       Patient[]            @relation("PatientUpdatedBy")
  recordedVitals        Vital[]              @relation("VitalRecordedBy")
  prescribedMedications Medication[]
  appointments          Appointment[]
  clinicalNotes         ClinicalNote[]
  careTeamAssignments   CareTeamAssignment[]
  orderedLabResults     LabResult[]          @relation("LabOrderedBy")
  reviewedLabResults    LabResult[]          @relation("LabReviewedBy")
  uploadedDocuments     Document[]
  createdInvoices       Invoice[]            @relation("InvoiceCreatedBy")
  processedPayments     Payment[]            @relation("PaymentProcessedBy")
  createdReferrals      Referral[]           @relation("ReferralCreatedBy")
  referredToReferrals   Referral[]           @relation("ReferralReferredTo")
  auditLogs             AuditLog[]
  sessions              Session[]
  hubTeamMembers        HubTeamMember[]
  consentPhysician      Consent[]            @relation("ConsentPhysician")
  consentWitness        Consent[]            @relation("ConsentWitness")
  consentSigner         Consent[]            @relation("ConsentSigner")
  administeredVaccinations Vaccination[]     @relation("VaccinationAdministeredBy")
  verifiedVaccinations  Vaccination[]        @relation("VaccinationVerifiedBy")
  surgicalNoteSurgeon    SurgicalNote[]      @relation("SurgicalNoteSurgeon")
  surgicalNoteAnesthesiologist SurgicalNote[] @relation("SurgicalNoteAnesthesiologist")
  nutritionEntryDietitian NutritionEntry[]   @relation("NutritionEntryDietitian")

  @@index([email])
  @@index([role])
  @@index([isActive])
  @@map("users")
}

model Session {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  refreshToken String   @unique @map("refresh_token")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([refreshToken])
  @@index([expiresAt])
  @@map("sessions")
}

model Patient {
  id                String   @id @default(uuid())
  name              String
  dateOfBirth       DateTime @map("date_of_birth")
  gender            String
  bloodPressure     String?  @map("blood_pressure")
  condition         String?
  riskScore         Int?     @map("risk_score")
  address           String?
  email             String?
  phone             String?
  preferredLanguage String?  @default("English") @map("preferred_language")

  // JSONB fields (stored as JSON in Prisma)
  emergencyContact   Json?
  insurance          Json?
  allergies          String[]
  familyHistory      String[]
  pharmacogenomics   Json?
  socialDeterminants Json?
  lifestyle          Json?
  immunizations      Json?
  advancedDirectives Json?

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String?  @map("created_by_id")
  updatedById String?  @map("updated_by_id")

  // Relations
  createdBy       User?                @relation("PatientCreatedBy", fields: [createdById], references: [id])
  updatedBy       User?                @relation("PatientUpdatedBy", fields: [updatedById], references: [id])
  medications     Medication[]
  appointments    Appointment[]
  clinicalNotes   ClinicalNote[]
  imagingStudies  ImagingStudy[]
  labResults      LabResult[]
  documents       Document[]
  timelineEvents  TimelineEvent[]
  careTeamMembers CareTeamAssignment[]
  invoices        Invoice[]
  referrals       Referral[]
  auditLogs       AuditLog[]
  vitals          Vital[]
  consents        Consent[]
  vaccinations    Vaccination[]
  surgicalNotes   SurgicalNote[]
  nutritionEntries NutritionEntry[]

  @@index([name])
  @@index([condition])
  @@index([riskScore])
  @@index([createdAt])
  @@map("patients")
}

model Medication {
  id             String           @id @default(uuid())
  patientId      String           @map("patient_id")
  name           String
  status         MedicationStatus
  startedDate    DateTime         @map("started_date")
  instructions   String?
  prescribedById String?          @map("prescribed_by_id")
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  patient      Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  prescribedBy User?   @relation(fields: [prescribedById], references: [id])

  @@index([patientId])
  @@index([status])
  @@map("medications")
}

model Vital {
  id              String   @id @default(uuid())
  patientId       String   @map("patient_id")
  date            DateTime
  time            String?
  systolic        Int?
  diastolic       Int?
  heartRate       Int?     @map("heart_rate")
  temperature     Float?
  oxygen          Int?     // SpO2 percentage
  notes           String?  @db.Text
  recordedById    String?  @map("recorded_by_id")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  patient    Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  recordedBy User?   @relation("VitalRecordedBy", fields: [recordedById], references: [id])

  @@index([patientId])
  @@index([date])
  @@index([recordedById])
  @@map("vitals")
}

model Appointment {
  id               String            @id @default(uuid())
  patientId        String            @map("patient_id")
  date             DateTime
  time             String
  type             String
  providerId       String            @map("provider_id")
  status           AppointmentStatus
  notes            String?
  consultationType String?           @map("consultation_type")
  specialty        String?
  duration         Int?
  location         String?
  reason           String?
  referralRequired Boolean           @default(false) @map("referral_required")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")

  patient  Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  provider User    @relation(fields: [providerId], references: [id])

  @@index([patientId])
  @@index([date])
  @@index([providerId])
  @@index([status])
  @@map("appointments")
}

model ClinicalNote {
  id               String           @id @default(uuid())
  patientId        String           @map("patient_id")
  title            String
  content          String           @db.Text
  authorId         String           @map("author_id")
  date             DateTime
  type             ClinicalNoteType
  consultationType String?          @map("consultation_type")
  specialty        String?
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  author  User    @relation(fields: [authorId], references: [id])

  @@index([patientId])
  @@index([authorId])
  @@index([date])
  @@map("clinical_notes")
}

model Referral {
  id                    String           @id @default(uuid())
  patientId             String           @map("patient_id")
  date                  DateTime
  specialty             String
  reason                String           @db.Text
  diagnosis             String?          @db.Text
  priority              ReferralPriority
  status                ReferralStatus  @default(pending)
  referringPhysicianId  String?          @map("referring_physician_id")
  referredToProviderId  String?          @map("referred_to_provider_id")
  referredToProviderName String?          @map("referred_to_provider")
  referredToFacility    String?          @map("referred_to_facility")
  referredToAddress     String?          @map("referred_to_address")
  referredToPhone       String?          @map("referred_to_phone")
  appointmentDate       DateTime?        @map("appointment_date")
  appointmentTime       String?          @map("appointment_time")
  notes                 String?          @db.Text
  attachments           String[]
  insurancePreAuth      Boolean          @default(false) @map("insurance_pre_auth")
  preAuthNumber         String?          @map("pre_auth_number")
  followUpRequired      Boolean          @default(false) @map("follow_up_required")
  followUpDate          DateTime?        @map("follow_up_date")
  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")

  patient           Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  referringPhysician User?   @relation("ReferralCreatedBy", fields: [referringPhysicianId], references: [id])
  referredToProvider User?   @relation("ReferralReferredTo", fields: [referredToProviderId], references: [id])

  @@index([patientId])
  @@index([date])
  @@index([status])
  @@index([referringPhysicianId])
  @@index([referredToProviderId])
  @@map("referrals")
}

model ImagingStudy {
  id                  String          @id @default(uuid())
  patientId           String          @map("patient_id")
  type                String
  modality            ImagingModality
  bodyPart            String          @map("body_part")
  date                DateTime
  findings            String          @db.Text
  status              ImagingStatus
  reportUrl           String?         @map("report_url")
  orderingPhysicianId String?         @map("ordering_physician_id")
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([date])
  @@map("imaging_studies")
}

model TimelineEvent {
  id                String            @id @default(uuid())
  patientId         String            @map("patient_id")
  date              DateTime
  type              TimelineEventType
  title             String
  description       String?           @db.Text
  icon              String?
  relatedEntityType String?           @map("related_entity_type")
  relatedEntityId   String?           @map("related_entity_id")
  createdAt         DateTime          @default(now()) @map("created_at")

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([date])
  @@map("timeline_events")
}

model CareTeamAssignment {
  id           String   @id @default(uuid())
  patientId    String   @map("patient_id")
  userId       String   @map("user_id")
  role         String
  specialty    String?
  assignedDate DateTime @map("assigned_date")
  notes        String?  @db.Text
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([patientId, userId])
  @@index([patientId])
  @@index([userId])
  @@map("care_team_assignments")
}

model LabResult {
  id                  String    @id @default(uuid())
  patientId           String    @map("patient_id")
  testName            String    @map("test_name")
  testCode            String?   @map("test_code")
  category            String? // e.g., "Blood Work", "Urine", "Microbiology"
  orderedDate         DateTime  @map("ordered_date")
  collectedDate       DateTime? @map("collected_date")
  resultDate          DateTime? @map("result_date")
  status              LabStatus
  results             Json? // Flexible structure for test results with values, units, etc.
  referenceRanges     Json?     @map("reference_ranges") // Normal ranges for comparison
  interpretation      String?   @db.Text // Clinical interpretation
  notes               String?   @db.Text
  orderingPhysicianId String?   @map("ordering_physician_id")
  reviewedById        String?   @map("reviewed_by_id")
  reviewedAt          DateTime? @map("reviewed_at")
  labName             String?   @map("lab_name")
  labLocation         String?   @map("lab_location")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  patient           Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  orderingPhysician User?   @relation("LabOrderedBy", fields: [orderingPhysicianId], references: [id])
  reviewedBy        User?   @relation("LabReviewedBy", fields: [reviewedById], references: [id])

  @@index([patientId])
  @@index([testName])
  @@index([orderedDate])
  @@index([status])
  @@index([orderingPhysicianId])
  @@map("lab_results")
}

model Document {
  id             String       @id @default(uuid())
  patientId      String?      @map("patient_id") // Optional for general documents
  documentType   DocumentType @map("document_type")
  title          String
  fileName       String       @map("file_name")
  fileUrl        String       @map("file_url")
  fileSize       Int?         @map("file_size") // in bytes
  mimeType       String?      @map("mime_type")
  description    String?      @db.Text
  uploadedById   String       @map("uploaded_by_id")
  uploadedAt     DateTime     @default(now()) @map("uploaded_at")
  tags           String[] // For categorization/search
  isConfidential Boolean      @default(false) @map("is_confidential")
  metadata       Json? // Additional metadata (version, related entities, etc.)
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  patient    Patient? @relation(fields: [patientId], references: [id], onDelete: Cascade)
  uploadedBy User     @relation(fields: [uploadedById], references: [id])

  @@index([patientId])
  @@index([documentType])
  @@index([uploadedAt])
  @@index([uploadedById])
  @@index([tags])
  @@map("documents")
}

model Invoice {
  id                String        @id @default(uuid())
  patientId         String        @map("patient_id")
  invoiceNumber     String        @unique @map("invoice_number")
  status            InvoiceStatus @default(draft)
  currency          String        @default("NGN") // ISO 4217 currency code (USD, NGN, EUR, etc.)
  subtotal          Decimal       @db.Decimal(15, 2) // Amount before tax/discount
  taxAmount         Decimal       @default(0) @db.Decimal(15, 2) @map("tax_amount")
  discountAmount    Decimal       @default(0) @db.Decimal(15, 2) @map("discount_amount")
  totalAmount       Decimal       @db.Decimal(15, 2) @map("total_amount")
  paidAmount        Decimal       @default(0) @db.Decimal(15, 2) @map("paid_amount")
  balanceAmount     Decimal       @db.Decimal(15, 2) @map("balance_amount") // totalAmount - paidAmount
  issueDate         DateTime      @map("issue_date")
  dueDate           DateTime?     @map("due_date")
  paidDate          DateTime?     @map("paid_date")
  notes             String?       @db.Text
  billingAddress    Json?         @map("billing_address") // Patient billing address
  relatedEntityType String?       @map("related_entity_type") // e.g., "appointment", "medication", "lab"
  relatedEntityId   String?       @map("related_entity_id")
  createdById       String        @map("created_by_id")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  patient     Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  createdBy   User         @relation("InvoiceCreatedBy", fields: [createdById], references: [id])
  items       InvoiceItem[]
  payments    Payment[]

  @@index([patientId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([issueDate])
  @@index([dueDate])
  @@index([currency])
  @@map("invoices")
}

model InvoiceItem {
  id          String   @id @default(uuid())
  invoiceId   String   @map("invoice_id")
  description String
  quantity    Decimal  @default(1) @db.Decimal(10, 2)
  unitPrice   Decimal  @db.Decimal(15, 2) @map("unit_price")
  taxRate     Decimal  @default(0) @db.Decimal(5, 2) @map("tax_rate") // Percentage (e.g., 7.5 for 7.5%)
  discount    Decimal  @default(0) @db.Decimal(15, 2) // Absolute discount amount
  totalAmount Decimal  @db.Decimal(15, 2) @map("total_amount") // (quantity * unitPrice - discount) * (1 + taxRate/100)
  serviceCode String?  @map("service_code") // CPT/HCPCS codes for medical billing
  category    String?  // e.g., "consultation", "medication", "lab", "imaging", "procedure"
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_items")
}

model Payment {
  id            String        @id @default(uuid())
  invoiceId     String        @map("invoice_id")
  amount        Decimal       @db.Decimal(15, 2)
  currency      String        @default("NGN") // ISO 4217 currency code
  paymentMethod PaymentMethod @map("payment_method")
  status        PaymentStatus @default(pending)
  transactionId String?       @unique @map("transaction_id") // External payment gateway transaction ID
  paymentDate   DateTime      @map("payment_date")
  notes         String?       @db.Text
  processedById String?       @map("processed_by_id")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  processedBy User?   @relation("PaymentProcessedBy", fields: [processedById], references: [id])

  @@index([invoiceId])
  @@index([status])
  @@index([paymentDate])
  @@index([transactionId])
  @@map("payments")
}

model BillingSettings {
  id                String   @id @default(uuid())
  organizationName String?  @map("organization_name")
  defaultCurrency   String   @default("NGN") @map("default_currency") // ISO 4217 code
  taxRate           Decimal  @default(0) @db.Decimal(5, 2) @map("tax_rate") // Default tax rate percentage
  taxEnabled        Boolean  @default(false) @map("tax_enabled")
  currencySymbols   Json?    @map("currency_symbols") // Map of currency codes to symbols: {"USD": "$", "NGN": "₦", "EUR": "€"}
  exchangeRates     Json?    @map("exchange_rates") // Base currency exchange rates (updated periodically)
  invoicePrefix     String   @default("INV") @map("invoice_prefix")
  invoiceNumber     Int      @default(1) @map("invoice_number") // Auto-incrementing invoice number
  paymentTerms      Int      @default(30) @map("payment_terms") // Days until payment due
  billingAddress    Json?    @map("billing_address")
  contactInfo       Json?    @map("contact_info")
  bankDetails       Json?    @map("bank_details") // For wire transfers
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@unique([id])
  @@map("billing_settings")
}

enum AuditActionType {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  REGISTER
  EXPORT
  VIEW
  PRINT
  ACCESS_DENIED
}

model AuditLog {
  id            String         @id @default(uuid())
  userId        String?         @map("user_id") // User who performed the action
  userEmail     String?         @map("user_email") // Denormalized for easier querying
  userRole      String?         @map("user_role") // Denormalized for easier querying
  action        AuditActionType
  resourceType  String          @map("resource_type") // e.g., "Patient", "Medication", "ClinicalNote"
  resourceId    String?        @map("resource_id") // ID of the affected resource
  patientId     String?        @map("patient_id") // If action involves a patient (for HIPAA compliance)
  ipAddress     String?         @map("ip_address")
  userAgent     String?         @map("user_agent")
  requestMethod String?         @map("request_method") // HTTP method (GET, POST, etc.)
  requestPath   String?         @map("request_path") // API endpoint
  statusCode    Int?            @map("status_code") // HTTP status code
  changes       Json? // Before/after values for updates
  metadata      Json? // Additional context (error messages, validation errors, etc.)
  success       Boolean         @default(true) // Whether the action succeeded
  errorMessage  String?         @db.Text @map("error_message")
  timestamp     DateTime        @default(now()) @map("timestamp")

  // Relations
  user    User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  patient Patient? @relation(fields: [patientId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([patientId])
  @@index([resourceType, resourceId])
  @@index([action])
  @@index([timestamp])
  @@index([userEmail])
  @@map("audit_logs")
}

model Hub {
  id          String   @id @default(uuid())
  name        String
  description String   @db.Text
  color       String   // e.g., "red", "blue", "green", "purple", etc.
  isActive    Boolean  @default(true) @map("is_active")
  specialties String[] // Array of specialty names
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  hubFunctions  HubFunction[]  @relation("HubFunctions")
  hubResources  HubResource[]  @relation("HubResources")
  hubNotes      HubNote[]      @relation("HubNotes")
  hubTemplates  HubTemplate[]  @relation("HubTemplates")
  hubTeamMembers HubTeamMember[] @relation("HubTeamMembers")

  @@index([isActive])
  @@index([name])
  @@map("hubs")
}

model HubFunction {
  id          String   @id @default(uuid())
  hubId       String   @map("hub_id")
  name        String
  description String?  @db.Text
  category    String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  hub Hub @relation("HubFunctions", fields: [hubId], references: [id], onDelete: Cascade)

  @@index([hubId])
  @@map("hub_functions")
}

model HubResource {
  id          String   @id @default(uuid())
  hubId       String   @map("hub_id")
  title       String
  type        String   // "protocol", "guideline", "reference", "tool", "link"
  url         String?  @db.Text
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  hub Hub @relation("HubResources", fields: [hubId], references: [id], onDelete: Cascade)

  @@index([hubId])
  @@index([type])
  @@map("hub_resources")
}

model HubNote {
  id        String   @id @default(uuid())
  hubId     String   @map("hub_id")
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  hub Hub @relation("HubNotes", fields: [hubId], references: [id], onDelete: Cascade)

  @@index([hubId])
  @@map("hub_notes")
}

model HubTemplate {
  id          String   @id @default(uuid())
  hubId       String?  @map("hub_id")
  name        String
  description String?  @db.Text
  template    Json     // Flexible JSON structure for consultation template
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  hub Hub? @relation("HubTemplates", fields: [hubId], references: [id], onDelete: SetNull)

  @@index([hubId])
  @@map("hub_templates")
}

model HubTeamMember {
  id        String   @id @default(uuid())
  hubId     String   @map("hub_id")
  userId    String   @map("user_id")
  role      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  hub Hub @relation("HubTeamMembers", fields: [hubId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([hubId, userId])
  @@index([hubId])
  @@index([userId])
  @@map("hub_team_members")
}

enum ConsentType {
  procedure
  surgery
  anesthesia
  blood_transfusion
  imaging_contrast
  research
  photography
  other
}

enum ConsentStatus {
  pending
  signed
  declined
  expired
  revoked
}

model Consent {
  id              String        @id @default(uuid())
  patientId       String        @map("patient_id")
  date            DateTime
  type            ConsentType
  title           String
  description     String        @db.Text
  status          ConsentStatus @default(pending)
  procedureName   String?       @map("procedure_name")
  risks           String[]      // Array of risk descriptions
  benefits        String[]      // Array of benefit descriptions
  alternatives    String[]      // Array of alternative descriptions
  signedBy        String?       @map("signed_by") // Patient or guardian name
  signedById      String?       @map("signed_by_id")
  witnessName     String?       @map("witness_name")
  witnessId       String?       @map("witness_id")
  physicianName   String?       @map("physician_name")
  physicianId     String?       @map("physician_id")
  signedDate      DateTime?     @map("signed_date")
  signedTime      String?       @map("signed_time")
  expirationDate  DateTime?     @map("expiration_date")
  notes           String?       @db.Text
  digitalSignature String?      @map("digital_signature") @db.Text
  printedSignature Boolean      @default(false) @map("printed_signature")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  physician User?   @relation("ConsentPhysician", fields: [physicianId], references: [id])
  witness   User?   @relation("ConsentWitness", fields: [witnessId], references: [id])
  signer    User?   @relation("ConsentSigner", fields: [signedById], references: [id])

  @@index([patientId])
  @@index([date])
  @@index([status])
  @@index([type])
  @@index([patientId, status])
  @@index([patientId, date])
  @@index([expirationDate])
  @@map("consents")
}

enum VaccinationRoute {
  intramuscular
  subcutaneous
  oral
  intranasal
  intradermal
}

model Vaccination {
  id                String           @id @default(uuid())
  patientId         String           @map("patient_id")
  vaccineName       String           @map("vaccine_name")
  vaccineCode       String?          @map("vaccine_code")
  date              DateTime
  administeredById  String?          @map("administered_by_id")
  location          String?
  route             VaccinationRoute?
  site              String?
  lotNumber         String?          @map("lot_number")
  manufacturer      String?
  expirationDate    DateTime?        @map("expiration_date")
  doseNumber        Int?             @map("dose_number")
  totalDoses        Int?             @map("total_doses")
  nextDoseDate      DateTime?        @map("next_dose_date")
  adverseReactions  String[]         @map("adverse_reactions")
  notes             String?          @db.Text
  verified          Boolean          @default(false)
  verifiedBy        String?          @map("verified_by")
  verifiedById      String?         @map("verified_by_id")
  verifiedDate      DateTime?        @map("verified_date")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")

  patient        Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  administeredBy User?   @relation("VaccinationAdministeredBy", fields: [administeredById], references: [id])
  verifiedByUser User?   @relation("VaccinationVerifiedBy", fields: [verifiedById], references: [id])

  @@index([patientId])
  @@index([date])
  @@index([vaccineName])
  @@index([vaccineCode])
  @@index([patientId, date])
  @@index([patientId, verified])
  @@index([verified])
  @@index([vaccineName, date])
  @@map("vaccinations")
}

enum SurgicalProcedureType {
  elective
  emergency
  urgent
  scheduled
}

enum SurgicalStatus {
  scheduled
  in_progress
  completed
  cancelled
  postponed
}

model SurgicalNote {
  id                    String                @id @default(uuid())
  patientId             String                @map("patient_id")
  date                  DateTime
  procedureName         String                @map("procedure_name")
  procedureType         SurgicalProcedureType  @map("procedure_type")
  status                SurgicalStatus        @default(scheduled)
  surgeonId             String?               @map("surgeon_id")
  assistantSurgeons     String[]              @map("assistant_surgeons") // Array of user IDs
  anesthesiologistId    String?               @map("anesthesiologist_id")
  anesthesiaType        String?               @map("anesthesia_type")
  indication            String                @db.Text
  preoperativeDiagnosis String                @map("preoperative_diagnosis") @db.Text
  postoperativeDiagnosis String?              @map("postoperative_diagnosis") @db.Text
  procedureDescription  String                @map("procedure_description") @db.Text
  findings              String?               @db.Text
  complications         String?               @db.Text
  estimatedBloodLoss    String?               @map("estimated_blood_loss")
  specimens             String[]              // Array of specimen descriptions
  drains                String?               @db.Text
  postOpInstructions     String?               @map("post_op_instructions") @db.Text
  recoveryNotes         String?               @map("recovery_notes") @db.Text
  followUpDate          DateTime?             @map("follow_up_date")
  operatingRoom         String?               @map("operating_room")
  duration              Int?                   // Duration in minutes
  startTime             String?                @map("start_time")
  endTime              String?                @map("end_time")
  createdAt             DateTime              @default(now()) @map("created_at")
  updatedAt             DateTime              @updatedAt @map("updated_at")

  patient         Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  surgeon         User?   @relation("SurgicalNoteSurgeon", fields: [surgeonId], references: [id])
  anesthesiologist User?  @relation("SurgicalNoteAnesthesiologist", fields: [anesthesiologistId], references: [id])

  @@index([patientId])
  @@index([date])
  @@index([status])
  @@index([procedureType])
  @@index([patientId, status])
  @@index([patientId, date])
  @@index([surgeonId, date])
  @@index([date, status])
  @@map("surgical_notes")
}

enum NutritionEntryType {
  assessment
  plan
  consultation
  monitoring
}

model NutritionEntry {
  id                  String              @id @default(uuid())
  patientId           String              @map("patient_id")
  date                DateTime
  type                NutritionEntryType
  dietitianId         String?             @map("dietitian_id")
  dietaryRestrictions String[]            @map("dietary_restrictions")
  allergies           String[]            // Array of allergy descriptions
  currentDiet         String?              @map("current_diet") @db.Text
  recommendedDiet    String?             @map("recommended_diet") @db.Text
  nutritionalGoals   String[]            @map("nutritional_goals")
  caloricNeeds        Float?              @map("caloric_needs")
  proteinNeeds        Float?              @map("protein_needs") // grams
  fluidNeeds          Float?              @map("fluid_needs") // ml
  supplements         Json?               // Array of { name, dosage, frequency, reason? }
  mealPlan            Json?                @map("meal_plan") // Array of { meal, description, calories? }
  weight              Float?               // kg
  height              Float?              // cm
  bmi                 Float?
  notes               String?             @db.Text
  followUpDate        DateTime?           @map("follow_up_date")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  dietitian User?   @relation("NutritionEntryDietitian", fields: [dietitianId], references: [id])

  @@index([patientId])
  @@index([date])
  @@index([type])
  @@index([patientId, date])
  @@index([patientId, type])
  @@index([dietitianId, date])
  @@map("nutrition_entries")
}
